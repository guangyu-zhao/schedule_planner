<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Planner</title>
    <script>
        (function() {
            var t = localStorage.getItem('theme');
            if (t) document.documentElement.setAttribute('data-theme', t);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/schedule.css">
    <link rel="stylesheet" href="/static/css/timer.css">
    <link rel="stylesheet" href="/static/css/stats.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/user.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="/static/js/i18n.js"></script>
</head>
<body>
    <div id="app">
        <nav class="top-bar">
            <h1 class="logo">üìÖ <span data-i18n="app.title">Schedule Planner</span></h1>
            <div class="tab-nav">
                <button class="tab active" data-page="schedule">üìã <span data-i18n="nav.schedule">Schedule</span></button>
                <button class="tab" data-page="timer">
                    ‚è±Ô∏è <span data-i18n="nav.timer">Timer</span><span class="timer-badge" id="timerBadge"></span>
                </button>
                <button class="tab" data-page="stats">üìä <span data-i18n="nav.stats">Statistics</span></button>
            </div>
            <div class="top-bar-spacer"></div>
            <button class="theme-toggle" id="themeToggle" data-i18n-title="nav.toggleTheme" title="Toggle theme">
                <span class="theme-icon" id="themeIcon">üåô</span>
            </button>
            <div class="user-menu" id="userMenu">
                <button class="user-menu-btn" id="userMenuBtn">
                    <div class="user-avatar-small" id="userAvatarSmall">
                        <span id="userAvatarInitial">U</span>
                        <img id="userAvatarImg" style="display:none" alt="">
                    </div>
                    <span class="user-name-text" id="userNameText" data-i18n="user.default">User</span>
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="user-avatar-medium" id="dropdownAvatar">
                            <span id="dropdownAvatarInitial">U</span>
                            <img id="dropdownAvatarImg" style="display:none" alt="">
                        </div>
                        <div>
                            <div class="dropdown-username" id="dropdownUsername">User</div>
                            <div class="dropdown-email" id="dropdownEmail">user@email.com</div>
                        </div>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <button class="dropdown-item" onclick="openProfile()">
                        <span class="dropdown-icon">üë§</span><span data-i18n="user.profile">Profile</span>
                    </button>
                    <button class="dropdown-item" onclick="exportData()">
                        <span class="dropdown-icon">üì•</span><span data-i18n="user.exportJSON">Export Data (JSON)</span>
                    </button>
                    <button class="dropdown-item" onclick="exportCSV()">
                        <span class="dropdown-icon">üìä</span><span data-i18n="user.exportCSV">Export Data (CSV)</span>
                    </button>
                    <button class="dropdown-item" onclick="exportICal()">
                        <span class="dropdown-icon">üìÖ</span><span data-i18n="user.exportICal">Export Calendar (iCal)</span>
                    </button>
                    <button class="dropdown-item" onclick="importData()">
                        <span class="dropdown-icon">üì§</span><span data-i18n="user.importData">Import Data</span>
                    </button>
                    <button class="dropdown-item" onclick="document.getElementById('shortcutsModal').classList.add('active');document.getElementById('userDropdown').classList.remove('active');">
                        <span class="dropdown-icon">‚å®Ô∏è</span><span data-i18n="user.shortcuts">Keyboard Shortcuts</span>
                    </button>
                    <div class="user-dropdown-divider"></div>
                    <button class="dropdown-item dropdown-item-danger" onclick="handleLogout()">
                        <span class="dropdown-icon">üö™</span><span data-i18n="user.logout">Sign Out</span>
                    </button>
                </div>
            </div>
        </nav>

        <div class="offline-banner" id="offlineBanner" data-i18n="user.offline">üîå Network disconnected...</div>

        {% include 'partials/schedule.html' %}
        {% include 'partials/timer.html' %}
        {% include 'partials/stats.html' %}
    </div>

    {% include 'partials/modal.html' %}

    <!-- Profile Drawer -->
    <div class="drawer-overlay" id="profileOverlay">
        <div class="drawer" id="profileDrawer">
            <div class="drawer-header">
                <h3 data-i18n="profile.title">Profile</h3>
                <button class="drawer-close" onclick="closeProfile()">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="profile-avatar-section">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="profileAvatarInitial">U</span>
                        <img id="profileAvatarImg" style="display:none" alt="">
                        <label class="avatar-upload-overlay" for="avatarInput">
                            <span data-i18n="profile.changeAvatar">Change Avatar</span>
                        </label>
                    </div>
                    <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none" onchange="handleAvatarUpload(this)">
                </div>
                <div class="profile-section">
                    <h4 data-i18n="profile.basicInfo">Basic Information</h4>
                    <div class="profile-field">
                        <label data-i18n="profile.username">Username</label>
                        <input type="text" id="profileUsername" data-i18n-placeholder="profile.username.placeholder" placeholder="Enter username" maxlength="30">
                    </div>
                    <div class="profile-field">
                        <label data-i18n="profile.bio">Bio</label>
                        <textarea id="profileBio" data-i18n-placeholder="profile.bio.placeholder" placeholder="Tell us about yourself..." maxlength="200" rows="3"></textarea>
                    </div>
                    <div class="profile-field">
                        <label data-i18n="profile.email">Email</label>
                        <input type="email" id="profileEmail" disabled>
                    </div>
                    <div class="profile-field">
                        <label data-i18n="profile.createdAt">Registered</label>
                        <input type="text" id="profileCreatedAt" disabled>
                    </div>
                    <button class="profile-save-btn" onclick="saveProfile()" data-i18n="profile.save">Save</button>
                </div>
                <div class="profile-section">
                    <h4 data-i18n="profile.changePassword">Change Password</h4>
                    <div class="profile-field">
                        <label data-i18n="profile.oldPassword">Old Password</label>
                        <input type="password" id="pwdOld" data-i18n-placeholder="profile.oldPassword.placeholder" placeholder="Enter current password" autocomplete="current-password">
                    </div>
                    <div class="profile-field">
                        <label data-i18n="profile.newPassword">New Password</label>
                        <input type="password" id="pwdNew" data-i18n-placeholder="profile.newPassword.placeholder" placeholder="At least 8 characters, letters and numbers" autocomplete="new-password">
                    </div>
                    <div class="profile-field">
                        <label data-i18n="profile.confirmPassword">Confirm Password</label>
                        <input type="password" id="pwdConfirm" data-i18n-placeholder="profile.confirmPassword.placeholder" placeholder="Re-enter new password" autocomplete="new-password">
                    </div>
                    <button class="profile-save-btn" onclick="changePassword()" data-i18n="profile.changePasswordBtn">Change Password</button>
                </div>
                <div class="profile-section">
                    <h4 data-i18n="profile.language">Language</h4>
                    <div class="profile-field">
                        <select id="profileLanguage" class="profile-lang-select"></select>
                    </div>
                </div>
                <div class="profile-section danger-zone">
                    <h4 data-i18n="profile.dangerZone">Danger Zone</h4>
                    <p class="danger-text" data-i18n="profile.dangerText">Deleting your account will permanently remove all data and cannot be undone.</p>
                    <button class="profile-danger-btn" onclick="deleteAccount()" data-i18n="profile.deleteAccount">Delete Account</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/static/js/app.js"></script>
    <script src="/static/js/user.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js', { scope: '/' })
                .catch(function() {});
        }
    </script>
</body>
</html>
