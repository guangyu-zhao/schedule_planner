<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥ç¨‹è§„åˆ’å™¨</title>
    <script>
        (function() {
            var t = localStorage.getItem('theme');
            if (t) document.documentElement.setAttribute('data-theme', t);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“…</text></svg>">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/schedule.css">
    <link rel="stylesheet" href="/static/css/timer.css">
    <link rel="stylesheet" href="/static/css/stats.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/user.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
    <div id="app">
        <nav class="top-bar">
            <h1 class="logo">ğŸ“… æ—¥ç¨‹è§„åˆ’å™¨</h1>
            <div class="tab-nav">
                <button class="tab active" data-page="schedule">ğŸ“‹ æ—¥ç¨‹å®‰æ’è¡¨</button>
                <button class="tab" data-page="timer">
                    â±ï¸ è®¡æ—¶å™¨
                    <span class="timer-badge" id="timerBadge"></span>
                </button>
                <button class="tab" data-page="stats">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>
            </div>
            <div class="top-bar-spacer"></div>
            <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
                <span class="theme-icon" id="themeIcon">ğŸŒ™</span>
            </button>
            <div class="user-menu" id="userMenu">
                <button class="user-menu-btn" id="userMenuBtn">
                    <div class="user-avatar-small" id="userAvatarSmall">
                        <span id="userAvatarInitial">U</span>
                        <img id="userAvatarImg" style="display:none" alt="">
                    </div>
                    <span class="user-name-text" id="userNameText">ç”¨æˆ·</span>
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="user-avatar-medium" id="dropdownAvatar">
                            <span id="dropdownAvatarInitial">U</span>
                            <img id="dropdownAvatarImg" style="display:none" alt="">
                        </div>
                        <div>
                            <div class="dropdown-username" id="dropdownUsername">ç”¨æˆ·</div>
                            <div class="dropdown-email" id="dropdownEmail">user@email.com</div>
                        </div>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <button class="dropdown-item" onclick="openProfile()">
                        <span class="dropdown-icon">ğŸ‘¤</span>ä¸ªäººèµ„æ–™
                    </button>
                    <button class="dropdown-item" onclick="exportData()">
                        <span class="dropdown-icon">ğŸ“¥</span>å¯¼å‡ºæ•°æ® (JSON)
                    </button>
                    <button class="dropdown-item" onclick="exportCSV()">
                        <span class="dropdown-icon">ğŸ“Š</span>å¯¼å‡ºæ•°æ® (CSV)
                    </button>
                    <button class="dropdown-item" onclick="exportICal()">
                        <span class="dropdown-icon">ğŸ“…</span>å¯¼å‡ºæ—¥å† (iCal)
                    </button>
                    <button class="dropdown-item" onclick="importData()">
                        <span class="dropdown-icon">ğŸ“¤</span>å¯¼å…¥æ•°æ®
                    </button>
                    <button class="dropdown-item" onclick="document.getElementById('shortcutsModal').classList.add('active');document.getElementById('userDropdown').classList.remove('active');">
                        <span class="dropdown-icon">âŒ¨ï¸</span>å¿«æ·é”®
                    </button>
                    <div class="user-dropdown-divider"></div>
                    <button class="dropdown-item dropdown-item-danger" onclick="handleLogout()">
                        <span class="dropdown-icon">ğŸšª</span>é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </nav>

        <div class="offline-banner" id="offlineBanner">ğŸ”Œ ç½‘ç»œå·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨</div>

        {% include 'partials/schedule.html' %}
        {% include 'partials/timer.html' %}
        {% include 'partials/stats.html' %}
    </div>

    {% include 'partials/modal.html' %}

    <!-- Profile Drawer -->
    <div class="drawer-overlay" id="profileOverlay">
        <div class="drawer" id="profileDrawer">
            <div class="drawer-header">
                <h3>ä¸ªäººèµ„æ–™</h3>
                <button class="drawer-close" onclick="closeProfile()">&times;</button>
            </div>
            <div class="drawer-body">
                <!-- Avatar Section -->
                <div class="profile-avatar-section">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="profileAvatarInitial">U</span>
                        <img id="profileAvatarImg" style="display:none" alt="">
                        <label class="avatar-upload-overlay" for="avatarInput">
                            <span>æ›´æ¢å¤´åƒ</span>
                        </label>
                    </div>
                    <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none" onchange="handleAvatarUpload(this)">
                </div>

                <!-- Profile Info -->
                <div class="profile-section">
                    <h4>åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="profile-field">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="profileUsername" placeholder="è¾“å…¥ç”¨æˆ·å" maxlength="30">
                    </div>
                    <div class="profile-field">
                        <label>ä¸ªäººç®€ä»‹</label>
                        <textarea id="profileBio" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±..." maxlength="200" rows="3"></textarea>
                    </div>
                    <div class="profile-field">
                        <label>é‚®ç®±</label>
                        <input type="email" id="profileEmail" disabled>
                    </div>
                    <div class="profile-field">
                        <label>æ³¨å†Œæ—¶é—´</label>
                        <input type="text" id="profileCreatedAt" disabled>
                    </div>
                    <button class="profile-save-btn" onclick="saveProfile()">ä¿å­˜ä¿®æ”¹</button>
                </div>

                <!-- Change Password -->
                <div class="profile-section">
                    <h4>ä¿®æ”¹å¯†ç </h4>
                    <div class="profile-field">
                        <label>åŸå¯†ç </label>
                        <input type="password" id="pwdOld" placeholder="è¾“å…¥åŸå¯†ç " autocomplete="current-password">
                    </div>
                    <div class="profile-field">
                        <label>æ–°å¯†ç </label>
                        <input type="password" id="pwdNew" placeholder="è‡³å°‘ 8 ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—" autocomplete="new-password">
                    </div>
                    <div class="profile-field">
                        <label>ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="pwdConfirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="new-password">
                    </div>
                    <button class="profile-save-btn" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
                </div>

                <!-- Danger Zone -->
                <div class="profile-section danger-zone">
                    <h4>å±é™©æ“ä½œ</h4>
                    <p class="danger-text">åˆ é™¤è´¦æˆ·åï¼Œæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ä¸”ä¸å¯æ¢å¤ã€‚</p>
                    <button class="profile-danger-btn" onclick="deleteAccount()">åˆ é™¤è´¦æˆ·</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/static/js/app.js"></script>
    <script src="/static/js/user.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js', { scope: '/' })
                .catch(function() {});
        }
    </script>
</body>
</html>
